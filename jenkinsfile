pipeline {
    agent any

    environment {
        AWS_REGION = "ap-south-1"
        AWS_CREDENTIALS = credentials('aws-credentials')
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/DikshanshuC/packer-ami-pipeline.git'
            }
        }

        stage('Install Packer if Not Present') {
            steps {
                script {
                    sh '''
                    if ! command -v packer &> /dev/null
                    then
                      echo "Packer not found! Installing..."
                      # Because we have passwordless sudo, this won't prompt for a password
                      sudo apt-get update -y
                      sudo apt-get install -y curl gnupg software-properties-common
                      curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
                      sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
                      sudo apt-get update -y
                      sudo apt-get install -y packer
                      packer --version
                    else
                      echo "Packer is already installed at $(which packer)"
                    fi
                    '''
                }
            }
        }

        stage('Validate Packer Configuration') {
            steps {
                sh 'packer validate packer.pkr.hcl'
            }
        }

        stage('Build AMI with Packer') {
            steps {
                sh """
                  packer init .
                  packer build -var 'aws_region=${AWS_REGION}' packer.pkr.hcl
                """
            }
        }

        stage('Notify') {
            steps {
                echo "AMI build completed successfully!"
            }
        }
    }
}

